import os
from pathlib import Path
import re

def natural_sort_key(path):
    """æ•°å­—ã‚’è€ƒæ…®ã—ãŸè‡ªç„¶é †ã‚½ãƒ¼ãƒˆç”¨ã®ã‚­ãƒ¼"""
    parts = re.split(r'(\d+)', str(path))
    return [int(part) if part.isdigit() else part.lower() for part in parts]

def collect_all_files(directory):
    output_file = "å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã¾ã¨ã‚.txt"
    base_path = Path(directory)
    
    with open(output_file, 'w', encoding='utf-8') as out:
        out.write("=" * 80 + "\n")
        out.write("ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ \n")
        out.write("=" * 80 + "\n\n")
        
        # ãƒ•ã‚©ãƒ«ãƒ€ã‚’æ•°å­—é †ã«ã‚½ãƒ¼ãƒˆ
        folders = sorted([f for f in base_path.iterdir() if f.is_dir()], key=natural_sort_key)
        
        for folder in folders:
            out.write(f"ğŸ“ {folder.name}/\n")
            files = sorted([f for f in folder.rglob('*') if f.is_file()], key=natural_sort_key)
            for file in files:
                relative = file.relative_to(folder)
                indent = '  ' * (len(relative.parts) - 1)
                out.write(f'  {indent}ğŸ“„ {relative}\n')
            out.write('\n')
        
        out.write("\n")
        out.write("=" * 80 + "\n")
        out.write("ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹\n")
        out.write("=" * 80 + "\n\n")
        
        # ãƒ•ã‚©ãƒ«ãƒ€ã”ã¨ã«æ•°å­—é †ã«å‡¦ç†
        for folder in folders:
            out.write(f"\n{'#'*80}\n")
            out.write(f"### {folder.name} ###\n")
            out.write(f"{'#'*80}\n\n")
            
            files = sorted([f for f in folder.rglob('*') if f.is_file()], key=natural_sort_key)
            
            for file_path in files:
                relative_path = file_path.relative_to(base_path)
                
                out.write(f"\n{'='*80}\n")
                out.write(f"ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«: {relative_path}\n")
                out.write(f"{'='*80}\n\n")
                
                try:
                    with open(file_path, 'r', encoding='utf-8') as f:
                        content = f.read()
                        out.write(content)
                        out.write("\n\n")
                except UnicodeDecodeError:
                    try:
                        with open(file_path, 'r', encoding='shift-jis') as f:
                            content = f.read()
                            out.write(content)
                            out.write("\n\n")
                    except Exception as e:
                        out.write(f"[èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: {e}]\n\n")
                except Exception as e:
                    out.write(f"[èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: {e}]\n\n")
        
        # çµ±è¨ˆæƒ…å ±
        total_files = sum(1 for _ in base_path.rglob('*') if _.is_file())
        total_folders = len(folders)
        
        out.write(f"\n{'='*80}\n")
        out.write(f"çµ±è¨ˆ: ãƒ•ã‚©ãƒ«ãƒ€æ•° {total_folders}å€‹ã€ãƒ•ã‚¡ã‚¤ãƒ«æ•° {total_files}å€‹\n")
        out.write(f"{'='*80}\n")
    
    print(f"âœ… å®Œäº†! {output_file} ã«å‡ºåŠ›ã—ã¾ã—ãŸ")
    print(f"ğŸ“Š ãƒ•ã‚©ãƒ«ãƒ€æ•°: {total_folders}å€‹ã€ãƒ•ã‚¡ã‚¤ãƒ«æ•°: {total_files}å€‹")

# å®Ÿè¡Œ
collect_all_files(r"C:\Users\yukik\Desktop\python_programming")

